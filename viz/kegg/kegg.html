<!DOCTYPE html>
<html>
<head>
<title>viz kegg test</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="./lib/snowflake.js"></script>
</head>
<body>
<div id="menu">
<select id="kegg" name="kegg"></select>
</div>
<div id="main">
</div>
<script>
function norm(data)
    {   var sum=0.0
        for(var i in data) {sum+=data[i]}
        var b=[] 
        if(sum==0) {sum=1.0};
        for(var i in data) {b.push(data[i]/sum)}
        return b
    }    

 function getUrlParam(name) {
             return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
        }    
 function getUrlParamList(name) {
		var a=getUrlParam(name)
		if(!a) { return undefined}
                a=a.split(",")
                var b=[] 
                a.forEach(function(d){b.push(parseInt(d))})
                return b;
        }    

(function($,d3){
var parseUrlTsv = function(url,callback) {
 $.ajax({
        type:     "GET",
        url:      url,
        dataType: "text",
        success: function(fdata){
             var x=fdata.split("\n");
             var cols=x[0].split("\t");
             var data={}
        data["table"]={}
        data["table"]["cols"]=[]
        data["table"]["rows"]=[]
        cols.forEach(function(d){data.table.cols.push({"label":d})})
        var j=0;
        for(var i=1;i<x.length;i++) {
        var r=x[i].split("\t");
        if(r.length == cols.length) {
                data.table.rows.push({"c":[]});
                r.forEach(function(d) {data.table.rows[j].c.push({"v":d})})
                j+=1;
                }
        }
        process(data)
        }
});
}
var map1={};
var map2={};
var url=getUrlParam("q") || "http://garberwiki.umassmed.edu:8000/data/D01_Mouse.LpsSet.cls2.tsv";



var process=function(data) {
var cols1=getUrlParamList("cols1") || [7,8,9,10,11];
var cols2=getUrlParamList("cols2") || [12,13,14,15,16];
console.log(data);
data.table.rows.forEach(function(d){
	var genename=d.c[0].v.toUpperCase();
	var d1=[];cols1.forEach(function(d0){d1.push(parseFloat(d.c[d0].v))})
	var d2=[];cols2.forEach(function(d0){d2.push(parseFloat(d.c[d0].v))})
	map1[genename]=norm(d1)
	map2[genename]=norm(d2)

})
var keggxmls=[{"id":1,"name":"cytokine and receptors","file":"hsa04060.xml"},
		{"id":2,"name":"Toll-like pathway","file":"hsa04620.xml"},
		{"id":3,"name":"Cancer pathways","file":"hsa05200.xml"},
		{"id":4,"name":"B Cell Receptor","file":"hsa04662.xml"},
		]
d3.select("#kegg")
	.selectAll("option")
	.data(keggxmls)
	.enter()
	.append("option")
	.attr("value",function(d){return d.file})
	.append("text").text(function(d){return d.name});

var render = function() {
d3.select("#main").selectAll("*").remove();
var svg=d3.select("#main").append("svg").attr("height",2000).attr("width",2800);
d3.xml($("#kegg").val(),"application/xml",function(xml){
 	var entrys=xml.documentElement.getElementsByTagName("entry");
	rects=[];
	id2xy={}
	for(var i=0;i<entrys.length;i++) {	
		var d=entrys[i];
		console.log(d);
		var e={}
		var id=d3.select(d).attr("id")
		var name=d3.select(d).attr("name")
		var type=d3.select(d).attr("type")
		e.id=id;
		e.name=name;
		e.type=type;
		e.graph={};
		var graph=d3.select(d).select("graphics")
		var attrs=["fgcolor","bgcolor","name","type","x","y","width","height"]
		attrs.forEach(function(a){e.graph[a]=graph.attr(a)})
		e.graph.x*=1.7;
		e.graph.x-=30;
		e.values1=[]
		e.values2=[]
		if(e.graph.name){
		var n=e.graph.name.split(",")[0]
		console.log(map1);
		if(n && map1[n]) {
		e.values1=map1[n];
		e.values2=map2[n];
		}
		}
		if(e.type!="group"){
		rects.push(e)
		}
		id2xy[id]={"x":parseInt(e.graph.x),"y":parseInt(e.graph.y),"width":parseInt(e.graph.width),"height":parseInt(e.graph.height)}
	}
	var rects = svg.selectAll(".rect").data(rects).enter().append("g")
			.attr("class","rect")
			.attr("transform",function(d) { return "translate("+d.graph.x+","+d.graph.y+")"})
	
	rects.append("rect")
		.attr("x",0)
		.attr("y",0)
		.attr("width",function(d){return d.graph.width})
		.attr("height",function(d){return d.graph.height})
		.attr("fill",function(d){return d.graph.bgcolor})
		.attr("stroke","black")
		.attr("stroke-width","0.5")
	rects.append("text")
		.text(function(d){
			if(d.graph.name){
			var x=d.graph.name.split(","); return x[0]
			}
			else {
			return "";
			}
			})
		.attr("color",function(d){return d.graph.fgcolor})
		.attr("font-size",8)
		.attr("y",12)
		.attr("x",4);
	var color = d3.scale.linear()
              .domain([0,1])
              .range(["white", "red"]);
	rects.append("g")
		.attr("class","value")
		.attr("transform",function(d){return "translate("+(parseInt(d.graph.width)+5)+",0)"})
		.selectAll(".val")
		.data(function(d){return d.values1})
		.enter()
		.append("rect")
		.attr("class","val")
		.attr("x",function(d,i){return i*10})
		.attr("y",function(d,i){return 0})
		.attr("height",function(d,i){return 5})
		.attr("width",function(d,i){return 10})
		.attr("opacity",0.8)
		.attr("fill",function(d,i){return color(d)});
	rects.append("g")
		.attr("class","value")
		.attr("transform",function(d){return "translate("+(parseInt(d.graph.width)+5)+",7)"})
		.selectAll(".val")
		.data(function(d){return d.values2})
		.enter()
		.append("rect")
		.attr("class","val")
		.attr("x",function(d,i){return i*10})
		.attr("y",function(d,i){return 0})
		.attr("height",function(d,i){return 5})
		.attr("width",function(d,i){return 10})
		.attr("opacity",0.8)
		.attr("fill",function(d,i){return color(d)});
 	var arrows=xml.documentElement.getElementsByTagName("relation");
	console.log(arrows)
	lines=[];
	for(var i=0;i<entrys.length;i++) {
	var d=d3.select(arrows[i]);
	console.log(d);
	if(d[0][0]) {
	var start=id2xy[d.attr("entry1")]
	var end=id2xy[d.attr("entry2")]
	lines.push([start.x+start.width,start.y+start.height/2,end.x,end.y+end.height/2])	
	}
	}
	console.log(lines);
	var glines=svg.selectAll(".line").data(lines).enter().append("g").attr("class","line")
	glines.append("line")
	     .attr("x1",function(d){return d[0]})
	     .attr("y1",function(d){return d[1]})
	     .attr("x2",function(d){return d[2]})
	     .attr("y2",function(d){return d[3]})
	     .attr("stroke","gray")
	     .attr("stroke-width","2")
	     .attr("opacity",0.7);
}
)
}
render()
$("#kegg").on("change",function(d){render()});
}
parseUrlTsv(url,process);
}(jQuery,d3))
</script>
</body>
</html>

